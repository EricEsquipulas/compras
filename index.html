<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste d'Achats</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Liste d'Achats">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%23FFD700' stroke-width='2'%3E%3Cline x1='32' y1='2' x2='32' y2='8'/%3E%3Cline x1='32' y1='56' x2='32' y2='62'/%3E%3Cline x1='2' y1='32' x2='8' y2='32'/%3E%3Cline x1='56' y1='32' x2='62' y2='32'/%3E%3Cline x1='11.5' y1='11.5' x2='16' y2='16'/%3E%3Cline x1='48' y1='48' x2='52.5' y2='52.5'/%3E%3Cline x1='52.5' y1='11.5' x2='48' y2='16'/%3E%3Cline x1='16' y1='48' x2='11.5' y2='52.5'/%3E%3Cline x1='20' y1='6' x2='22' y2='12'/%3E%3Cline x1='42' y1='52' x2='44' y2='58'/%3E%3Cline x1='6' y1='20' x2='12' y2='22'/%3E%3Cline x1='52' y1='42' x2='58' y2='44'/%3E%3Cline x1='6' y1='44' x2='12' y2='42'/%3E%3Cline x1='52' y1='22' x2='58' y2='20'/%3E%3Cline x1='20' y1='58' x2='22' y2='52'/%3E%3Cline x1='42' y1='12' x2='44' y2='6'/%3E%3C/g%3E%3Cpath d='M32 50C32 50 48 38 48 26C48 20 44 16 38 16C35 16 32 18 32 18S29 16 26 16C20 16 16 20 16 26C16 38 32 50 32 50Z' fill='%23DC2626'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cg stroke='%23FFD700' stroke-width='2'%3E%3Cline x1='32' y1='2' x2='32' y2='8'/%3E%3Cline x1='32' y1='56' x2='32' y2='62'/%3E%3Cline x1='2' y1='32' x2='8' y2='32'/%3E%3Cline x1='56' y1='32' x2='62' y2='32'/%3E%3Cline x1='11.5' y1='11.5' x2='16' y2='16'/%3E%3Cline x1='48' y1='48' x2='52.5' y2='52.5'/%3E%3Cline x1='52.5' y1='11.5' x2='48' y2='16'/%3E%3Cline x1='16' y1='48' x2='11.5' y2='52.5'/%3E%3Cline x1='20' y1='6' x2='22' y2='12'/%3E%3Cline x1='42' y1='52' x2='44' y2='58'/%3E%3Cline x1='6' y1='20' x2='12' y2='22'/%3E%3Cline x1='52' y1='42' x2='58' y2='44'/%3E%3Cline x1='6' y1='44' x2='12' y2='42'/%3E%3Cline x1='52' y1='22' x2='58' y2='20'/%3E%3Cline x1='20' y1='58' x2='22' y2='52'/%3E%3Cline x1='42' y1='12' x2='44' y2='6'/%3E%3C/g%3E%3Cpath d='M32 50C32 50 48 38 48 26C48 20 44 16 38 16C35 16 32 18 32 18S29 16 26 16C20 16 16 20 16 26C16 38 32 50 32 50Z' fill='%23DC2626'/%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTGlzdGUgZCdBY2hhdHMiLCJzaG9ydF9uYW1lIjoiTGlzdGUgZCdBY2hhdHMiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzI1NjNlYiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIwdmlld0JveCUzRCUyNzAlMjAwJTIwNjQlMjA2NCUyNyUyMHhtbG5zJTNEJTI3aHR0cCUzQSUyRiUyRnd3dy53My5vcmclMkYyMDAwJTJGc3ZnJTI3JTNFJTNDZyUyMHN0cm9rZSUzRCUyNyUyNTIzRkZENzAwJTI3JTIwc3Ryb2tlLXdpZHRoJTNEJTI3MiUyNyUzRSUzQ2xpbmUlMjB4MSUzRCUyNzMyJTI3JTIweTElM0QlMjcyJTI3JTIweDIlM0QlMjczMiUyNyUyMHkyJTNEJTI3OCUyNyUyRiUzRSUzQ2xpbmUlMjB4MSUzRCUyNzMyJTI3JTIweTElM0QlMjc1NiUyNyUyMHgyJTNEJTI3MzIlMjclMjB5MiUzRCUyNzYyJTI3JTJGJTNFJTNDbGluZSUyMHgxJTNEJTI3MiUyNyUyMHkxJTNEJTI3MzIlMjclMjB4MiUzRCUyNzglMjclMjB5MiUzRCUyNzMyJTI3JTJGJTNFJTNDbGluZSUyMHgxJTNEJTI3NTYlMjclMjB5MSUzRCUyNzMyJTI3JTIweDIlM0QlMjc2MiUyNyUyMHkyJTNEJTI3MzIlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjcxMS41JTI3JTIweTElM0QlMjcxMS41JTI3JTIweDIlM0QlMjcxNiUyNyUyMHkyJTNEJTI3MTYlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjc0OCUyNyUyMHkxJTNEJTI3NDglMjclMjB4MiUzRCUyNzUyLjUlMjclMjB5MiUzRCUyNzUyLjUlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjc1Mi41JTI3JTIweTElM0QlMjcxMS41JTI3JTIweDIlM0QlMjc0OCUyNyUyMHkyJTNEJTI3MTYlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjcxNiUyNyUyMHkxJTNEJTI3NDglMjclMjB4MiUzRCUyNzExLjUlMjclMjB5MiUzRCUyNzUyLjUlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjcyMCUyNyUyMHkxJTNEJTI3NiUyNyUyMHgyJTNEJTI3MjIlMjclMjB5MiUzRCUyNzEyJTI3JTJGJTNFJTNDbGluZSUyMHgxJTNEJTI3NDIlMjclMjB5MSUzRCUyNzUyJTI3JTIweDIlM0QlMjc0NCUyNyUyMHkyJTNEJTI3NTglMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjc2JTI3JTIweTElM0QlMjcyMCUyNyUyMHgyJTNEJTI3MTIlMjclMjB5MiUzRCUyNzIyJTI3JTJGJTNFJTNDbGluZSUyMHgxJTNEJTI3NTIlMjclMjB5MSUzRCUyNzQyJTI3JTIweDIlM0QlMjc1OCUyNyUyMHkyJTNEJTI3NDQlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjc2JTI3JTIweTElM0QlMjc0NCUyNyUyMHgyJTNEJTI3MTIlMjclMjB5MiUzRCUyNzQyJTI3JTJGJTNFJTNDbGluZSUyMHgxJTNEJTI3NTIlMjclMjB5MSUzRCUyNzIyJTI3JTIweDIlM0QlMjc1OCUyNyUyMHkyJTNEJTI3MjAlMjclMkYlM0UlM0NsaW5lJTIweDElM0QlMjcyMCUyNyUyMHkxJTNEJTI3NTglMjclMjB4MiUzRCUyNzIyJTI3JTIweTIlM0QlMjc1MiUyNyUyRiUzRSUzQ2xpbmUlMjB4MSUzRCUyNzQyJTI3JTIweTElM0QlMjcxMiUyNyUyMHgyJTNEJTI3NDQlMjclMjB5MiUzRCUyNzYlMjclMkYlM0UlM0MlMkZnJTNFJTNDcGF0aCUyMGQlM0QlMjdNMzIlMjA1MEMzMiUyMDUwJTIwNDglMjAzOCUyMDQ4JTIwMjZDNDglMjAyMCUyMDQ0JTIwMTYlMjAzOCUyMDE2QzM1JTIwMTYlMjAzMiUyMDE4JTIwMzIlMjAxOFMyOSUyMDE2JTIwMjYlMjAxNkMyMCUyMDE2JTIwMTYlMjAyMCUyMDE2JTIwMjZDMTYlMjAzOCUyMDMyJTIwNTAlMjAzMiUyMDUwWiUyNyUyMGZpbGwlM0QlMjclMjUyM0RDMjYyNiUyNyUyRiUzRSUzQyUyRnN2ZyUzRSIsInNpemVzIjoiYW55IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .currency-selector {
            margin-bottom: 10px;
        }

        .currency-selector select {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .total-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
        }

        .form-section {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .form-group {
            flex: 1;
            position: relative;
        }

        .form-group.small {
            flex: 0.7;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
        }

        .photo-section {
            text-align: center;
            margin-bottom: 15px;
        }

        .photo-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .photo-item {
            position: relative;
            width: 80px;
            height: 80px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .remove-photo {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
        }

        .add-photo-btn {
            width: 80px;
            height: 80px;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #94a3b8;
        }

        #photoInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }

        .conversion-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #0369a1;
        }

        .sync-section {
            background: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            text-align: center;
        }

        .sync-btn {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 0.9rem;
        }

        .sync-status {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #0369a1;
        }

        .items-list {
            padding: 20px;
        }

        .item-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #2563eb;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .item-total {
            font-weight: bold;
            color: #059669;
            font-size: 1.1rem;
        }

        .item-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .edit-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
            margin-right: 10px;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .summary-section {
            background: #f1f5f9;
            padding: 20px;
            margin-top: 20px;
        }

        .summary-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .vendor-summary {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="appTitle">
                <svg class="app-logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Rayons du soleil -->
                    <g stroke="#FFD700" stroke-width="2">
                        <line x1="32" y1="2" x2="32" y2="8"/>
                        <line x1="32" y1="56" x2="32" y2="62"/>
                        <line x1="2" y1="32" x2="8" y2="32"/>
                        <line x1="56" y1="32" x2="62" y2="32"/>
                        <line x1="11.5" y1="11.5" x2="16" y2="16"/>
                        <line x1="48" y1="48" x2="52.5" y2="52.5"/>
                        <line x1="52.5" y1="11.5" x2="48" y2="16"/>
                        <line x1="16" y1="48" x2="11.5" y2="52.5"/>
                        <line x1="20" y1="6" x2="22" y2="12"/>
                        <line x1="42" y1="52" x2="44" y2="58"/>
                        <line x1="6" y1="20" x2="12" y2="22"/>
                        <line x1="52" y1="42" x2="58" y2="44"/>
                        <line x1="6" y1="44" x2="12" y2="42"/>
                        <line x1="52" y1="22" x2="58" y2="20"/>
                        <line x1="20" y1="58" x2="22" y2="52"/>
                        <line x1="42" y1="12" x2="44" y2="6"/>
                    </g>
                    <!-- Cœur rouge -->
                    <path d="M32 50C32 50 48 38 48 26C48 20 44 16 38 16C35 16 32 18 32 18S29 16 26 16C20 16 16 20 16 26C16 38 32 50 32 50Z" fill="#DC2626"/>
                </svg>
                Liste d'Achats
            </h1>
            <div class="currency-selector">
                <select id="currencySelect" onchange="changeCurrency(this.value)">
                    <option value="GTQ">GTQ (Quetzal)</option>
                    <option value="MXN">MXN (Peso)</option>
                </select>
            </div>
            <div class="total-badge">
                Total: <span id="grandTotal">0,00</span> <span id="totalCurrency">GTQ</span>
                <br><small>≈ <span id="euroTotal">0,00</span> EUR</small>
            </div>
        </div>

        <div class="form-section">
            <div class="photo-section">
                <label>Photos du produit:</label>
                <div class="photo-gallery" id="photoGallery">
                    <button type="button" class="add-photo-btn" onclick="addPhoto()">📷</button>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(event)" multiple>
                <small style="color: #6b7280;">Touchez 📷 pour ajouter des photos (max 5)</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="productName">Produit</label>
                    <input type="text" id="productName" placeholder="Nom du produit" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="vendor">Fournisseur</label>
                    <input type="text" id="vendor" placeholder="Nom du vendeur" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group small">
                    <label for="quantity">Quantité</label>
                    <input type="number" id="quantity" step="1" min="1" placeholder="1" value="1">
                </div>
                <div class="form-group small">
                    <label for="unitPrice">Prix unitaire</label>
                    <input type="number" id="unitPrice" step="0.1" min="0" placeholder="0,00">
                </div>
                <div class="form-group small">
                    <label for="payment">Paiement</label>
                    <select id="payment">
                        <option value="Espèces" selected>Espèces</option>
                        <option value="Carte">Carte</option>
                        <option value="Chèque">Chèque</option>
                        <option value="Virement">Virement</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn" id="addBtn" onclick="addItem()">➕ Ajouter à la liste</button>
        </div>

        <div class="sync-section">
            <h3>☁️ Synchronisation</h3>
            <button class="sync-btn" onclick="exportData()">📤 Sauvegarder</button>
            <button class="sync-btn" onclick="importData()">📥 Récupérer</button>
            <div class="sync-status" id="syncStatus">Prêt</div>
        </div>

        <div class="items-list" id="itemsList">
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">🛍️</div>
                <p>Aucun article pour le moment</p>
                <p>Commencez à ajouter vos achats !</p>
            </div>
        </div>

        <div class="summary-section" id="summarySection" style="display: none;">
            <div class="summary-title">📊 Récapitulatif par fournisseur</div>
            <div id="vendorSummary"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let items = [];
        let currentPhotos = [];
        let editingItemId = null;
        let currency = 'GTQ';
        let userName = 'USER';

        // Initialisation
        function init() {
            try {
                // Nettoyer complètement les données corrompues
                localStorage.removeItem('marketItems'); // Reset complet
                items = [];
                
                currency = localStorage.getItem('selectedCurrency') || 'GTQ';
                userName = localStorage.getItem('userName') || 'USER';
                
                saveData();
                renderItems();
                updateTotal();
                
                const currencySelect = document.getElementById('currencySelect');
                if (currencySelect) currencySelect.value = currency;
                
                const totalCurrency = document.getElementById('totalCurrency');
                if (totalCurrency) totalCurrency.textContent = currency;
                
                console.log('App initialisée avec données nettoyées');
                
            } catch (error) {
                console.error('Erreur init:', error);
            }
        }

        function addPhoto() {
            const photoInput = document.getElementById('photoInput');
            if (photoInput) photoInput.click();
        }

        function handlePhoto(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file && currentPhotos.length < 5) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        currentPhotos.push(e.target.result);
                        updatePhotoDisplay();
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            if (event.target) event.target.value = '';
        }

        function updatePhotoDisplay() {
            const gallery = document.getElementById('photoGallery');
            if (!gallery) return;
            
            gallery.innerHTML = '';
            
            // Affiche les photos
            currentPhotos.forEach((photo, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo}" alt="Photo ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">×</button>
                `;
                gallery.appendChild(photoDiv);
            });
            
            // Bouton d'ajout
            if (currentPhotos.length < 5) {
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'add-photo-btn';
                addBtn.innerHTML = '📷';
                addBtn.onclick = addPhoto;
                gallery.appendChild(addBtn);
            }
        }

        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            updatePhotoDisplay();
        }

        function addItem() {
            try {
                const productName = getInputValue('productName');
                const vendor = getInputValue('vendor');
                const quantity = parseFloat(getInputValue('quantity')) || 1;
                const unitPrice = parseFloat(getInputValue('unitPrice')) || 0;
                const payment = getInputValue('payment') || 'Espèces';

                if (!productName.trim()) {
                    alert('Veuillez saisir un nom de produit');
                    return;
                }

                if (!vendor.trim()) {
                    alert('Veuillez saisir un nom de vendeur');
                    return;
                }

                const total = quantity * unitPrice;
                const timestamp = Date.now();

                if (editingItemId) {
                    // Mode édition
                    const itemIndex = items.findIndex(item => item.id == editingItemId); // == au lieu de ===
                    if (itemIndex !== -1) {
                        items[itemIndex] = {
                            ...items[itemIndex],
                            productName,
                            vendor,
                            quantity,
                            unitPrice,
                            total,
                            payment,
                            photos: [...currentPhotos],
                            currency: currency
                        };
                    }
                    editingItemId = null;
                    const addBtn = document.getElementById('addBtn');
                    if (addBtn) addBtn.textContent = '➕ Ajouter à la liste';
                } else {
                    // Mode ajout
                    const item = {
                        id: Date.now(), // ID simple sans caractères spéciaux
                        productName,
                        vendor,
                        quantity,
                        unitPrice,
                        total,
                        payment,
                        photos: [...currentPhotos],
                        timestamp: new Date().toISOString(),
                        currency: currency,
                        userId: userName
                    };
                    items.push(item);
                }

                saveData();
                renderItems();
                updateTotal();
                resetForm();

            } catch (error) {
                console.error('Erreur ajout item:', error);
                alert('Erreur lors de l\'ajout: ' + error.message);
            }
        }

        function getInputValue(id) {
            const element = document.getElementById(id);
            return element ? element.value : '';
        }

        function editItem(index) {
            try {
                const item = items[index];
                if (!item) return;

                setInputValue('productName', item.productName);
                setInputValue('vendor', item.vendor);
                setInputValue('quantity', item.quantity);
                setInputValue('unitPrice', item.unitPrice);
                setInputValue('payment', item.payment);

                currentPhotos = item.photos ? [...item.photos] : [];
                updatePhotoDisplay();

                editingItemId = item.id;
                const addBtn = document.getElementById('addBtn');
                if (addBtn) addBtn.textContent = '✏️ Modifier l\'article';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Erreur édition:', error);
            }
        }

        function setInputValue(id, value) {
            const element = document.getElementById(id);
            if (element) element.value = value;
        }

        function deleteItem(index) {
            console.log('deleteItem appelé avec index:', index);
            console.log('items avant suppression:', items.length);
            
            if (index >= 0 && index < items.length) {
                // Suppression directe sans confirm() car il est bloqué dans l'iframe
                items.splice(index, 1);
                console.log('items après suppression:', items.length);
                saveData();
                renderItems();
                updateTotal();
                alert('Article supprimé !'); // Feedback utilisateur
            } else {
                console.error('Index invalide:', index);
            }
        }

        function renderItems() {
            console.log('renderItems appelé, nombre d\'items:', items.length);
            
            const itemsList = document.getElementById('itemsList');
            const emptyState = document.getElementById('emptyState');
            const summarySection = document.getElementById('summarySection');

            if (!itemsList) {
                console.error('itemsList non trouvé');
                return;
            }

            if (items.length === 0) {
                console.log('Affichage état vide');
                if (emptyState) emptyState.style.display = 'block';
                if (summarySection) summarySection.style.display = 'none';
                itemsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🛍️</div>
                        <p>Aucun article pour le moment</p>
                        <p>Commencez à ajouter vos achats !</p>
                    </div>
                `;
                return;
            }

            console.log('Affichage des items');
            if (emptyState) emptyState.style.display = 'none';
            if (summarySection) summarySection.style.display = 'block';

            const itemsHTML = items.map((item, index) => {
                let photosHtml = '';
                if (item.photos && item.photos.length > 0) {
                    photosHtml = `
                        <div class="photo-gallery">
                            ${item.photos.slice(0, 3).map(photo => 
                                `<div class="photo-item"><img src="${photo}" alt="${item.productName}"></div>`
                            ).join('')}
                            ${item.photos.length > 3 ? `<div class="photo-item"><span>+${item.photos.length - 3}</span></div>` : ''}
                        </div>
                    `;
                }

                const total = item.total || 0;
                const euroEquivalent = convertToEuros(total);

                return `
                    <div class="item-card">
                        ${photosHtml}
                        <div class="item-header">
                            <div class="item-name">${item.productName}</div>
                            <div class="item-total">${total.toFixed(2)} ${currency}
                                <br><small>≈ ${euroEquivalent.toFixed(2)} EUR</small>
                            </div>
                        </div>
                        <div class="item-details">
                            <div><strong>Fournisseur:</strong> ${item.vendor}</div>
                            <div><strong>Quantité:</strong> ${item.quantity}</div>
                            <div><strong>Prix unitaire:</strong> ${(item.unitPrice || 0).toFixed(2)} ${currency}</div>
                            <div><strong>Paiement:</strong> ${item.payment}</div>
                        </div>
                        <button class="edit-btn" onclick="editItem(${index}); console.log('Edit clicked:', ${index})">✏️ Modifier</button>
                        <button class="delete-btn" onclick="deleteItem(${index}); console.log('Delete clicked:', ${index})">🗑️ Supprimer</button>
                    </div>
                `;
            }).join('');

            itemsList.innerHTML = itemsHTML;
            renderSummary();
        }

        function renderSummary() {
            const vendorSummary = document.getElementById('vendorSummary');
            if (!vendorSummary) return;

            const vendorTotals = {};
            items.forEach(item => {
                if (!vendorTotals[item.vendor]) {
                    vendorTotals[item.vendor] = 0;
                }
                vendorTotals[item.vendor] += item.total || 0;
            });

            const summaryHTML = Object.entries(vendorTotals).map(([vendor, total]) => `
                <div class="vendor-summary">
                    <div><strong>${vendor}</strong></div>
                    <div><strong>${total.toFixed(2)} ${currency}</strong>
                     <br><small>≈ ${convertToEuros(total).toFixed(2)} EUR</small></div>
                </div>
            `).join('');

            vendorSummary.innerHTML = summaryHTML;
        }

        function updateTotal() {
            const total = items.reduce((sum, item) => sum + (item.total || 0), 0);
            
            const grandTotal = document.getElementById('grandTotal');
            const euroTotal = document.getElementById('euroTotal');
            const totalCurrency = document.getElementById('totalCurrency');
            
            if (grandTotal) grandTotal.textContent = total.toFixed(2);
            if (totalCurrency) totalCurrency.textContent = currency;
            if (euroTotal) euroTotal.textContent = convertToEuros(total).toFixed(2);
        }

        function convertToEuros(amount) {
            // Taux approximatifs : GTQ ≈ 0.13 USD, MXN ≈ 0.055 USD, EUR ≈ 0.92 USD
            const rates = { GTQ: 0.13, MXN: 0.055, EUR: 0.92 };
            const usdAmount = amount * (rates[currency] || 0.13);
            return usdAmount / 0.92; // USD vers EUR
        }

        function changeCurrency(newCurrency) {
            currency = newCurrency;
            const totalCurrency = document.getElementById('totalCurrency');
            if (totalCurrency) totalCurrency.textContent = newCurrency;
            updateTotal();
            renderItems();
            saveData();
        }

        function resetForm() {
            setInputValue('productName', '');
            setInputValue('vendor', '');
            setInputValue('quantity', '1');
            setInputValue('unitPrice', '');
            setInputValue('payment', 'Espèces');
            
            currentPhotos = [];
            updatePhotoDisplay();
            editingItemId = null;
            
            const addBtn = document.getElementById('addBtn');
            if (addBtn) addBtn.textContent = '➕ Ajouter à la liste';
        }

        function saveData() {
            try {
                localStorage.setItem('marketItems', JSON.stringify(items));
                localStorage.setItem('selectedCurrency', currency);
                localStorage.setItem('userName', userName);
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
            }
        }

        function exportData() {
            try {
                const data = {
                    items: items,
                    userName: userName,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `marche-${userName}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                const syncStatus = document.getElementById('syncStatus');
                if (syncStatus) syncStatus.textContent = `Sauvegardé: ${new Date().toLocaleString()}`;
            } catch (error) {
                alert('Erreur export: ' + error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            if (confirm(`Importer ${data.items?.length || 0} articles ?`)) {
                                items = data.items || [];
                                saveData();
                                renderItems();
                                updateTotal();
                                
                                const syncStatus = document.getElementById('syncStatus');
                                if (syncStatus) syncStatus.textContent = `Importé: ${new Date().toLocaleString()}`;
                            }
                        } catch (error) {
                            alert('Erreur import: fichier invalide');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Initialisation au chargement
        window.onload = init;
    </script>
</body>
</html>
